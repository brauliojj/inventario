<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Sistema de Inventario</title>
  <!--PAW-->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1d4ed8">

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script><!--CONEXION A SUPABASE SDK-->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">

  <!-- LOGIN -->
<div id="loginView" class="min-h-screen flex items-center justify-center bg-gray-100">
  <div class="bg-white p-6 rounded-xl shadow w-full max-w-sm">
    <h2 class="text-2xl font-bold mb-4 text-center">üîê Iniciar sesi√≥n</h2>

    <input id="loginEmail" type="email" placeholder="Email"
      class="border p-2 rounded w-full mb-3" />

    <input id="loginPassword" type="password" placeholder="Contrase√±a"
      class="border p-2 rounded w-full mb-4" />

    <button onclick="login()"
      class="bg-blue-600 text-white w-full py-2 rounded mb-2">
      Entrar
    </button>

    <button onclick="register()"
      class="bg-gray-600 text-white w-full py-2 rounded">
      Registrarse
    </button>

    <p id="loginError" class="text-red-600 text-sm mt-2 text-center"></p>
  </div>
</div>


  <div id="appView" class="max-w-5xl mx-auto hidden">
    <h1 class="text-3xl font-bold mb-6">üì¶ Sistema de Inventario</h1>

    <button onclick="logout()"
      class="bg-red-600 text-white px-4 py-2 rounded mb-4">
      üö™ Cerrar sesi√≥n
    </button>

    <!-- FORMULARIO PRODUCTOS -->
    <div class="bg-white p-4 rounded-xl shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">‚ûï Cargar Producto</h2>
      <div class="grid grid-cols-4 gap-4">
        <input id="codigo" placeholder="C√≥digo" class="border p-2 rounded" />
        <input id="nombre" placeholder="Producto" class="border p-2 rounded" />
        <input id="cantidad" type="number" placeholder="Cantidad" class="border p-2 rounded" />
        <input id="precio" type="number" placeholder="Precio" class="border p-2 rounded" />
        <button onclick="agregarProducto()" class="bg-blue-600 text-white rounded">Guardar</button>
      </div>
    </div>

    <!-- TABLA INVENTARIO -->
    <div class="bg-white p-4 rounded-xl shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">üìã Inventario</h2>
      <input
        id="buscador"
        type="text"
        placeholder="üîç Buscar por c√≥digo, nombre o precio"
        class="border p-2 rounded w-full mb-4"
        onkeyup="render()"
      />

      <table class="w-full border">
        <thead class="bg-gray-200">
          <tr>
            <th>C√≥digo</th>
            <th>Producto</th>
            <th>Stock</th>
            <th>Cargados</th>
            <th>Vendidos</th>
            <th>Precio</th>
            <th>Total Vendido</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="tabla"></tbody>
      </table>
    </div>

    <!-- REPORTE -->
<div class="bg-white p-4 rounded-xl shadow">
  <h2 class="text-xl font-semibold mb-4">üìä Reporte</h2>

  <p>Total de productos cargados: <b id="totalProductos">0</b></p>
  <p>Total de unidades en stock: <b id="totalStock">0</b></p>
  <p>Total de unidades vendidas: <b id="totalVendidos">0</b></p>
  <p>Total general vendido: <b id="totalGeneralVendido">0</b></p>

  <!-- BOTONES DE DESCARGA -->
  <div class="flex gap-4 mt-4">
    <button onclick="exportarExcel()" class="bg-green-600 text-white px-4 py-2 rounded">
      Descargar Excel
    </button>

    <button onclick="exportarPDF()" class="bg-gray-800 text-white px-4 py-2 rounded">
      Descargar PDF
    </button>
  </div>

  <div class="mt-4">
  <button onclick="limpiarInventario()"
          class="bg-red-700 text-white px-4 py-2 rounded w-full">
    üóëÔ∏è Limpiar Inventario
  </button>
</div>

</div>

  </div>

<script>

// üîπ SUPABASE CONFIGURACI√ìN
const SUPABASE_URL = 'https://phkmjooeubaungvbtiwf.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable__Lkgaj8gmCn2tee5jjigcw_TbU5e24B';

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

// üîπ CARGAR INVENTARIO DESDE LOCALSTORAGE
let inventario = [];

async function cargarProductos() {
  const { data, error } = await supabaseClient
    .from('id_productos')
    .select('*')
    .order('nombre');

  if (error) {
    alert('Error cargando productos');
    console.error(error);
    return;
  }

  inventario = data;
  render();
}

async function obtenerUsuarioActual() {
  const { data } = await supabaseClient.auth.getUser();
  return data.user;
}


async function agregarProducto() {
  const codigo = document.getElementById('codigo').value.trim();
  const nombre = document.getElementById('nombre').value.trim();
  const cantidad = parseInt(document.getElementById('cantidad').value);
  const precio = parseFloat(document.getElementById('precio').value);

  if (!codigo || !nombre || cantidad <= 0 || precio <= 0) {
    alert('Complete todos los campos correctamente');
    return;
  }

  // Buscar si existe
  const { data: existente } = await supabaseClient
    .from('id_productos')
    .select('*')
    .eq('codigo', codigo)
    .single();

  if (existente) {
    // UPDATE
    const { error } = await supabaseClient
      .from('id_productos')
      .update({
        stock: existente.stock + cantidad,
        cargados: existente.cargados + cantidad,
        precio: precio
      })
      .eq('id', existente.id);

    if (error) {
      alert('Error actualizando producto');
      console.error(error);
      return;
    }
  } else {
    // INSERT
    const { error } = await supabaseClient
      .from('id_productos')
      .insert({
        codigo,
        nombre,
        stock: cantidad,
        cargados: cantidad,
        vendidos: 0,
        precio,
        total_vendido: 0
      });

    if (error) {
      alert('Error insertando producto');
      console.error(error);
      return;
    }
  }

  limpiar();
  cargarProductos();
}


async function vender(index) {
  const p = inventario[index];
  const user = await obtenerUsuarioActual();

  if (!user) {
    alert('Usuario no autenticado');
    return;
  }

  if (p.stock <= 0) {
    alert('Sin stock');
    return;
  }

  // 1Ô∏è‚É£ Actualizar producto
  await supabaseClient
    .from('id_productos')
    .update({
      stock: p.stock - 1,
      vendidos: p.vendidos + 1,
      total_vendido: Number(p.total_vendido || 0) + Number(p.precio || 0)
    })
    .eq('id', p.id);

  // 2Ô∏è‚É£ Registrar movimiento

const { error } = await supabaseClient
  .from('movimientos')
  .insert({
    producto_id: p.id,
    tipo: 'venta',          // üëà OBLIGATORIO (ver m√°s abajo)
    cantidad: 1,
    precio: Number(p.precio),
    usuario_id: user.id
  });

if (error) {
  console.error('Error insertando movimiento:', error);
  alert(error.message);
  return;
}


cargarProductos();

}

function render() {
  const tabla = document.getElementById('tabla');
  tabla.innerHTML = '';

  const textoBusqueda = document
    .getElementById('buscador')
    ?.value
    .toLowerCase() || '';

  let totalStock = 0;
  let totalVendidos = 0;
  let totalGeneralVendido = 0;

  inventario
    .filter(p => {
      return (
        p.codigo.toLowerCase().includes(textoBusqueda) ||
        p.nombre.toLowerCase().includes(textoBusqueda) ||
        p.precio.toString().includes(textoBusqueda)
      );
    })
    .forEach((p, i) => {

      totalStock += p.stock;
      totalVendidos += p.vendidos;
      totalGeneralVendido += Number(p.total_vendido || 0);

      tabla.innerHTML += `
        <tr class="text-center border">
          <td>${p.codigo}</td>
          <td>${p.nombre}</td>
          <td>${p.stock}</td>
          <td>${p.cargados}</td>
          <td>${p.vendidos}</td>
          <td>${Number(p.precio || 0).toFixed(2)}</td>
          <td>${Number(p.total_vendido || 0).toFixed(2)}</td>
          <td>
            <button onclick="vender(${i})"
              class="bg-red-500 text-white px-2 rounded mr-1">
              Vender
            </button>

            <button onclick="eliminarProducto(${i})"
              class="bg-gray-700 text-white px-2 rounded">
              Borrar
            </button>
          </td>
        </tr>`;
    });

  document.getElementById('totalProductos').innerText = inventario.length;
  document.getElementById('totalStock').innerText = totalStock;
  document.getElementById('totalVendidos').innerText = totalVendidos;
  document.getElementById('totalGeneralVendido').innerText =
    totalGeneralVendido.toFixed(2);
}


function limpiar() {
  document.getElementById('codigo').value = '';
  document.getElementById('nombre').value = '';
  document.getElementById('cantidad').value = '';
  document.getElementById('precio').value = '';
}

// üîπ EXPORTAR A EXCEL
function exportarExcel() {
  let csv = 'Codigo,Producto,Stock,Vendidos,Precio,TotalVendido\n';

  inventario.forEach(p => {
    csv += `${p.codigo},${p.nombre},${p.stock},${p.vendidos},${p.precio},${p.totalVendido}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'reporte_inventario.csv';
  link.click();
}

// üîπ EXPORTAR A PDF
function exportarPDF() {
  let contenido = 'REPORTE DE INVENTARIO\n\n';

  inventario.forEach(p => {
    contenido += `${p.codigo} - ${p.nombre}\n`;
    contenido += `Stock: ${p.stock} | Vendidos: ${p.vendidos}\n`;
    contenido += `Precio: ${p.precio} | Total Vendido: ${p.totalVendido}\n\n`;
  });

  const ventana = window.open('', '', 'height=500,width=700');
  ventana.document.write('<pre>' + contenido + '</pre>');
  ventana.document.close();
  ventana.print();
}

// üîπ LIMPIAR INVENTARIO COMPLETO
function limpiarInventario() {
  const confirmar = confirm(
    '‚ö†Ô∏è ATENCI√ìN\n\nEsto borrar√° TODO el inventario y las ventas.\n¬øDesea continuar?'
  );

  if (!confirmar) return;

  inventario = [];
  localStorage.removeItem('inventario');

  render();
}


// üîπ RENDER INICIAL
render();

// üîπ ELIMINAR PRODUCTO
async function eliminarProducto(index) {
  const p = inventario[index];

  if (!confirm(`¬øEliminar ${p.nombre}?`)) return;

  const { error } = await supabaseClient
    .from('id_productos')
    .delete()
    .eq('id', p.id);

  if (error) {
    alert('Error eliminando');
    console.error(error);
    return;
  }

  cargarProductos();
}


// üîê LOGIN
async function login() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  const errorBox = document.getElementById('loginError');

  errorBox.innerText = '';

  const { error } =
    await supabaseClient.auth.signInWithPassword({
      email,
      password
    });

  if (error) {
    errorBox.innerText = error.message;
    console.error(error);
  }
}

// üÜï REGISTRO
async function register() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  const errorBox = document.getElementById('loginError');

  errorBox.innerText = '';

  if (!email || !password) {
    errorBox.innerText = 'Email y contrase√±a son obligatorios';
    return;
  }

  // 1Ô∏è‚É£ Intentar login primero
  const { error: loginError } =
    await supabaseClient.auth.signInWithPassword({
      email,
      password
    });

  if (!loginError) {
    // Usuario ya exist√≠a y entr√≥
    return;
  }

  // 2Ô∏è‚É£ Si no existe, registrar
  const { error: signupError } =
    await supabaseClient.auth.signUp({
      email,
      password
    });

  if (signupError) {
    errorBox.innerText = signupError.message;
    console.error(signupError);
    return;
  }

  errorBox.innerText =
    'Usuario creado. Ahora pod√©s iniciar sesi√≥n.';
}



// üö™ LOGOUT
async function logout() {
  await supabaseClient.auth.signOut();
}

// üîé CONTROL DE SESI√ìN
supabaseClient.auth.onAuthStateChange((event, session) => {
  const loginView = document.getElementById('loginView');
  const appView = document.getElementById('appView');

  if (session) {
    loginView.classList.add('hidden');
    appView.classList.remove('hidden');
    cargarProductos();
  } else {
    appView.classList.add('hidden');
    loginView.classList.remove('hidden');
  }
});

</script>

</body>
</html>
