<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Sistema de Inventario</title>
  <!--PAW-->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1d4ed8">

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script><!--CONEXION A SUPABASE SDK-->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen">

  <!-- LOGIN -->
<div id="loginView" class="min-h-screen flex items-center justify-center bg-gray-100">
  <div class="bg-white p-6 rounded-xl shadow w-full max-w-sm">
    <h2 class="text-2xl font-bold mb-4 text-center">üîê Iniciar sesi√≥n</h2>

    <input id="loginEmail" type="email" placeholder="Email"
      class="border p-2 rounded w-full mb-3" />

    <input id="loginPassword" type="password" placeholder="Contrase√±a"
      class="border p-2 rounded w-full mb-4" />

    <button onclick="login()"
      class="bg-blue-600 text-white w-full py-2 rounded mb-2">
      Entrar
    </button>

    <button onclick="register()"
      class="bg-gray-600 text-white w-full py-2 rounded">
      Registrarse
    </button>

    <p id="loginError" class="text-red-600 text-sm mt-2 text-center"></p>
  </div>
</div>

  <div id="appView" class="max-w-6xl mx-auto p-6 hidden">
    
    <div class="flex justify-between items-center mb-8">
  <h1 class="text-3xl font-bold text-slate-800">
    üì¶ Sistema de Inventario
  </h1>

  <button onclick="logout()"
    class="bg-red-500 hover:bg-red-600 transition text-white px-4 py-2 rounded-lg shadow">
    üö™ Cerrar sesi√≥n
  </button>
</div>


    <div id="adminPanel" class="bg-white p-4 rounded-xl shadow mb-6 hidden">
  <h2 class="text-xl font-semibold mb-4">üßë‚Äçüíº Bienvenido</h2>

</div>


    <!-- FORMULARIO PRODUCTOS -->
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
      <h2 class="text-xl font-semibold mb-4">‚ûï Cargar Producto</h2>
      <div class="grid grid-cols-4 gap-4">
        <input id="codigo" placeholder="C√≥digo" class="border p-2 rounded" />
        <input id="nombre" placeholder="Producto" class="border p-2 rounded" />
        <input id="cantidad" type="number" placeholder="Cantidad" class="border p-2 rounded" />
        <input id="precio" type="number" placeholder="Precio" class="border p-2 rounded" />
        <button
            onclick="agregarProducto()"
            class="bg-blue-600 hover:bg-blue-700 transition text-white rounded-lg shadow px-4 py-2">
            Guardar
          </button>

      </div>
    </div>

    <!-- TABLA INVENTARIO -->
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
      <h2 class="text-xl font-semibold mb-4">üìã Inventario</h2>
      <input
        id="buscador"
        type="text"
        placeholder="üîç Buscar por c√≥digo, nombre o precio"
        class="border p-2 rounded w-full mb-4"
        onkeyup="render()"
      />

      <table class="w-full border-collapse overflow-hidden rounded-xl">
        <thead class="bg-gray-200">
          <tr>
            <th>C√≥digo</th>
            <th>Producto</th>
            <th>Stock</th>
            <th>Cargados</th>
            <th>Vendidos</th>
            <th>Precio</th>
            <th>Total Vendido</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="tabla"></tbody>
      </table>
    </div>

    <!-- REPORTE -->
<div class="bg-white p-4 rounded-xl shadow">
  <h2 class="text-xl font-semibold mb-4">üìä Reporte</h2>

  <p>Total de productos cargados: <b id="totalProductos">0</b></p>
  <p>Total de unidades en stock: <b id="totalStock">0</b></p>
  <p>Total de unidades vendidas: <b id="totalVendidos">0</b></p>
  <p>Total general vendido: <b id="totalGeneralVendido">0</b></p>

  <!-- BOTONES DE DESCARGA -->
  <div class="flex gap-4 mt-4">
    <button onclick="exportarExcel()" class="bg-green-600 text-white px-4 py-2 rounded">
      Descargar Excel
    </button>

    <button onclick="exportarPDF()" class="bg-gray-800 text-white px-4 py-2 rounded">
      Descargar PDF
    </button>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mt-6">
  <h2 class="text-xl font-semibold mb-4">üìÖ Historial de Ventas</h2>

  <div class="flex gap-4 mb-4">
  <input
    type="date"
    id="filtroFecha"
    class="border p-2 rounded"
    onchange="cargarHistorialVentas()"
  />

  <select
    id="filtroPeriodo"
    class="border p-2 rounded"
    onchange="cargarHistorialVentas()"
  >
    <option value="">Todo</option>
    <option value="mes">Este mes</option>
    <option value="anio">Este a√±o</option>
  </select>
</div>


  <table class="w-full border">
    <thead class="bg-gray-200">
      <tr>
        <th>Fecha</th>
        <th>Cantidad vendida</th>
        <th>Total vendido</th>
      </tr>
    </thead>
    <tbody id="tablaHistorial"></tbody>
  </table>
</div>


</div>

  </div>

<script>

// üîπ SUPABASE CONFIGURACI√ìN
const SUPABASE_URL = 'https://phkmjooeubaungvbtiwf.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable__Lkgaj8gmCn2tee5jjigcw_TbU5e24B';

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

// üîπ CARGAR INVENTARIO DESDE LOCALSTORAGE
let inventario = [];
let rolUsuario = 'user';

async function cargarProductos() {
  const { data, error } = await supabaseClient
    .from('id_productos')
    .select('*')
    .order('nombre');

  if (error) {
    alert('Error cargando productos');
    console.error(error);
    return;
  }

  inventario = data;
  render();
}

async function obtenerUsuarioActual() {
  const { data } = await supabaseClient.auth.getUser();
  return data.user;
}


async function agregarProducto() {
  const codigo = document.getElementById('codigo').value.trim();
  const nombre = document.getElementById('nombre').value.trim();
  const cantidad = parseInt(document.getElementById('cantidad').value);
  const precio = parseFloat(document.getElementById('precio').value);

  if (!codigo || !nombre || cantidad <= 0 || precio <= 0) {
    alert('Complete todos los campos correctamente');
    return;
  }

  // Buscar si existe
  const { data: existente } = await supabaseClient
    .from('id_productos')
    .select('*')
    .eq('codigo', codigo)
    .single();

  if (existente) {
    // UPDATE
    const { error } = await supabaseClient
      .from('id_productos')
      .update({
        stock: existente.stock + cantidad,
        cargados: existente.cargados + cantidad,
        precio: precio
      })
      .eq('id', existente.id);

    if (error) {
      alert('Error actualizando producto');
      console.error(error);
      return;
    }
  } else {
    // INSERT
    const { error } = await supabaseClient
      .from('id_productos')
      .insert({
        codigo,
        nombre,
        stock: cantidad,
        cargados: cantidad,
        vendidos: 0,
        precio,
        total_vendido: 0
      });

    if (error) {
      alert('Error insertando producto');
      console.error(error);
      return;
    }
  }

  limpiar();
  cargarProductos();
}


async function vender(index) {
  const p = inventario[index];
  const user = await obtenerUsuarioActual();

  if (!user) {
    alert('Usuario no autenticado');
    return;
  }

  if (p.stock <= 0) {
    alert('Sin stock');
    return;
  }

  // 1Ô∏è‚É£ Actualizar producto
  await supabaseClient
    .from('id_productos')
    .update({
      stock: p.stock - 1,
      vendidos: p.vendidos + 1,
      total_vendido: Number(p.total_vendido || 0) + Number(p.precio || 0)
    })
    .eq('id', p.id);

  // 2Ô∏è‚É£ Registrar movimiento

const { error } = await supabaseClient
  .from('movimientos')
  .insert({
    producto_id: p.id,
    tipo: 'venta',          // üëà OBLIGATORIO (ver m√°s abajo)
    cantidad: 1,
    precio: Number(p.precio),
    usuario_id: user.id
  });

if (error) {
  console.error('Error insertando movimiento:', error);
  alert(error.message);
  return;
}


cargarProductos();
cargarHistorialVentas(); // üëà actualiza el historial al instante

}

function render() {
  const tabla = document.getElementById('tabla');
  tabla.innerHTML = '';

  const textoBusqueda = document
    .getElementById('buscador')
    ?.value
    .toLowerCase() || '';

  let totalStock = 0;
  let totalVendidos = 0;
  let totalGeneralVendido = 0;

  inventario
    .filter(p => {
      return (
        p.codigo.toLowerCase().includes(textoBusqueda) ||
        p.nombre.toLowerCase().includes(textoBusqueda) ||
        p.precio.toString().includes(textoBusqueda)
      );
    })
    .forEach((p, i) => {

      totalStock += p.stock;
      totalVendidos += p.vendidos;
      totalGeneralVendido += Number(p.total_vendido || 0);

      tabla.innerHTML += `
        <tr class="text-center border">
          <td>${p.codigo}</td>
          <td>${p.nombre}</td>
          <td>${p.stock}</td>
          <td>${p.cargados}</td>
          <td>${p.vendidos}</td>
          <td>${Number(p.precio || 0).toFixed(2)}</td>
          <td>${Number(p.total_vendido || 0).toFixed(2)}</td>
          
          <td>
  <button onclick="vender(${i})"
    class="bg-red-500 text-white px-2 rounded mr-1">
    Vender
  </button>

  ${
    rolUsuario === 'admin'
      ? `<button
            onclick="eliminarProducto(${i})"
            class="bg-gray-700 text-white px-2 rounded">
            Borrar
         </button>`
      : ''
  }
</td>
      

        </tr>`;
    });

  document.getElementById('totalProductos').innerText = inventario.length;
  document.getElementById('totalStock').innerText = totalStock;
  document.getElementById('totalVendidos').innerText = totalVendidos;
  document.getElementById('totalGeneralVendido').innerText =
    totalGeneralVendido.toFixed(2);

     // üëá ESTA L√çNEA ES LA CLAVE
  //aplicarPermisosTabla();
}


function limpiar() {
  document.getElementById('codigo').value = '';
  document.getElementById('nombre').value = '';
  document.getElementById('cantidad').value = '';
  document.getElementById('precio').value = '';
}

// üîπ EXPORTAR A EXCEL
function exportarExcel() {
  let csv = 'Codigo,Producto,Stock,Vendidos,Precio,TotalVendido\n';

  inventario.forEach(p => {
    csv += `${p.codigo},${p.nombre},${p.stock},${p.vendidos},${p.precio},${p.totalVendido}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'reporte_inventario.csv';
  link.click();
}

// üîπ EXPORTAR A PDF
function exportarPDF() {
  let contenido = 'REPORTE DE INVENTARIO\n\n';

  inventario.forEach(p => {
    contenido += `${p.codigo} - ${p.nombre}\n`;
    contenido += `Stock: ${p.stock} | Vendidos: ${p.vendidos}\n`;
    contenido += `Precio: ${p.precio} | Total Vendido: ${p.totalVendido}\n\n`;
  });

  const ventana = window.open('', '', 'height=500,width=700');
  ventana.document.write('<pre>' + contenido + '</pre>');
  ventana.document.close();
  ventana.print();
}



// üîπ ELIMINAR PRODUCTO
async function eliminarProducto(index) {
  const p = inventario[index];

  if (!confirm(`¬øEliminar ${p.nombre}?`)) return;

  const { error } = await supabaseClient
    .from('id_productos')
    .delete()
    .eq('id', p.id);

  if (error) {
    alert('Error eliminando');
    console.error(error);
    return;
  }

  cargarProductos();
}


// üîê LOGIN
async function login() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  const errorBox = document.getElementById('loginError');

  errorBox.innerText = '';

  const { error } = await supabaseClient.auth.signInWithPassword({
    email,
    password
  });

  if (error) {
    errorBox.innerText = error.message;
    return;
  }

  // 1Ô∏è‚É£ mostrar app
  document.getElementById('loginView').classList.add('hidden');
  document.getElementById('appView').classList.remove('hidden');

  // 2Ô∏è‚É£ OBTENER ROL PRIMERO
  rolUsuario = await obtenerRolUsuario();
  console.log('ROL:', rolUsuario);

  // 3Ô∏è‚É£ aplicar permisos visuales
  aplicarPermisosAdmin();

  // 4Ô∏è‚É£ reci√©n ahora renderizar datos
  await cargarProductos();
  await cargarHistorialVentas();

  // 5Ô∏è‚É£ solo admin ve usuarios
  if (rolUsuario === 'admin') {
    await cargarUsuarios();
  }
}



// üÜï REGISTRO
async function register() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  const errorBox = document.getElementById('loginError');

  errorBox.innerText = '';

  if (!email || !password) {
    errorBox.innerText = 'Email y contrase√±a son obligatorios';
    return;
  }

  // 1Ô∏è‚É£ Intentar login primero
  const { error: loginError } =
    await supabaseClient.auth.signInWithPassword({
      email,
      password
    });

  if (!loginError) {
    // Usuario ya exist√≠a y entr√≥
    return;
  }

  // 2Ô∏è‚É£ Si no existe, registrar
  const { error: signupError } =
    await supabaseClient.auth.signUp({
      email,
      password
    });

  if (signupError) {
    errorBox.innerText = signupError.message;
    console.error(signupError);
    return;
  }

  errorBox.innerText =
    'Usuario creado. Ahora pod√©s iniciar sesi√≥n.';
}



// üö™ LOGOUT
async function logout() {
  await supabaseClient.auth.signOut();

  // üî• LIMPIEZA INMEDIATA DE UI
  document.getElementById('appView').classList.add('hidden');
  document.getElementById('loginView').classList.remove('hidden');

  inventario = [];
  rolUsuario = 'user';
}


// üîé CONTROL DE SESI√ìN
// üîé CONTROL DE SESI√ìN ‚Äî FORMA SEGURA SUPABASE v2
supabaseClient.auth.onAuthStateChange((event, session) => {
  console.log('Auth event:', event);

  if (!session) {
    document.getElementById('appView').classList.add('hidden');
    document.getElementById('loginView').classList.remove('hidden');
  }
});


async function cargarHistorialVentas() {
  let query = supabaseClient
    .from('movimientos')
    .select('created_at, cantidad, precio')
    .eq('tipo', 'venta')
    .order('created_at', { ascending: false });

  const fechaInput = document.getElementById('filtroFecha')?.value;
  const periodo = document.getElementById('filtroPeriodo')?.value;

  if (fechaInput) {
    const inicio = new Date(fechaInput);
    const fin = new Date(fechaInput);
    fin.setHours(23, 59, 59);

    query = query
      .gte('created_at', inicio.toISOString())
      .lte('created_at', fin.toISOString());
  }

  if (periodo === 'mes') {
    const inicioMes = new Date();
    inicioMes.setDate(1);
    inicioMes.setHours(0, 0, 0);

    query = query.gte('created_at', inicioMes.toISOString());
  }

  if (periodo === 'anio') {
    const inicioAnio = new Date(new Date().getFullYear(), 0, 1);
    query = query.gte('created_at', inicioAnio.toISOString());
  }

  const { data, error } = await query;

  if (error) {
    console.error('Error cargando historial:', error);
    return;
  }

  renderHistorialVentas(data);
}

function renderHistorialVentas(movimientos) {
  const tabla = document.getElementById('tablaHistorial');
  if (!tabla) return;

  tabla.innerHTML = '';

  const resumen = {};

  movimientos.forEach(m => {
    const fecha = new Date(m.created_at).toLocaleDateString('es-ES');

    if (!resumen[fecha]) {
      resumen[fecha] = { cantidad: 0, total: 0 };
    }

    resumen[fecha].cantidad += m.cantidad;
    resumen[fecha].total += Number(m.precio) * Number(m.cantidad);
  });

  Object.entries(resumen).forEach(([fecha, datos]) => {
    tabla.innerHTML += `
      <tr class="text-center border">
        <td>${fecha}</td>
        <td>${datos.cantidad}</td>
        <td>${datos.total.toFixed(2)}</td>
      </tr>
    `;
  });

}

async function obtenerRolUsuario() {
  const { data } = await supabaseClient.auth.getUser();
  if (!data?.user) return 'user';

  const email = data.user.email;

  // üëë ADMINS FIJOS
  const admins = [
    'brauliojarajara@gmail.com',
    'arielrodas@hotmail.com'
  ];

  if (admins.includes(email)) {
    return 'admin';
  }

  return 'user';
}


function aplicarPermisosAdmin() {
  const panel = document.getElementById('adminPanel');
  if (rolUsuario === 'admin') {
    panel.classList.remove('hidden');
  } else {
    panel.classList.add('hidden');
  }
}

async function cargarUsuarios() {
  const { data, error } = await supabaseClient
    .rpc('get_all_profiles');

  if (error) {
    console.error('Error cargando usuarios:', error);
    return;
  }

  renderUsuarios(data);
}


function renderUsuarios(usuarios) {
  const tabla = document.getElementById('tablaUsuarios');
  tabla.innerHTML = '';

  usuarios.forEach(u => {
    tabla.innerHTML += `
      <tr class="text-center border">
        <td>${u.email}</td>
        <td>${u.role}</td>
        <td>
          <button
            onclick="cambiarRol('${u.id}', '${u.role}')"
            class="bg-blue-600 text-white px-2 rounded">
            Cambiar rol
          </button>
        </td>
      </tr>
    `;
  });
}

async function cambiarRol(userId, rolActual) {
  const nuevoRol = rolActual === 'admin' ? 'user' : 'admin';

  if (!confirm(`¬øCambiar rol a ${nuevoRol}?`)) return;

  const { error } = await supabaseClient
    .from('profiles')
    .update({ role: nuevoRol })
    .eq('id', userId);

  if (error) {
    alert('Error cambiando rol');
    console.error(error);
    return;
  }

  alert('Rol cambiado. El usuario debe cerrar sesi√≥n y volver a entrar.');
  cargarUsuarios();
}


</script>

</body>
</html>
